<!-- design by William77 -->

<!DOCTYPE html>
<html>

<head>
    <title>Open-WebCode</title>
    <style>
        h1,
        h3 {
            margin: 0;
            padding: 0;
            color: #222;
        }

        h1 {
            color: #CCC;
        }

        button {
            margin-top: 12px;
        }
    </style>
</head>

<body style="font-family: Arial; background-color: #5a635f;">
    <h1 style="padding: 10px;">Open-WebCode v0.1
    </h1>
    <div style="padding: 0px 10px; margin-bottom: 56px;">design by william77</div>
    <h3 style="padding: 10px; color: #CCC;">簡單強悍易用，可將任意檔案轉換成 html 來儲存，檔案格式可以是 html, css, javascript, 任意文本格式,
        圖片資源、聲音等等 ( 檔案不要太大 )</h3>

    <div style="padding: 10px; margin: 12px 12px; border-left: 3px solid yellowgreen;">
        <h3>Convert Any Plain Text File to Open-WebCode</h3>
        <div style="color: #AAA;">轉換文本成 webcode html 格式</div>
        <input id="upload" type="file" style="display: none;" />
        <button id="uploadTrigger">Convert</button>
    </div>
    <div style="padding: 10px; margin: 16px 12px; border-left: 3px solid yellowgreen;">
        <h3>Load Open-WebCode HTML File</h3>
        <div style="color: #AAA;">讀取 webcode html 格式</div>
        <input id="uploadWC" type="file" style="display: none;" />
        <button id="uploadWCTrigger">Load WebCode</button>
        <div id="WCArea"></div>
    </div>

    <script src="https://code.jquery.com/jquery-3.7.1.min.js"
        integrity="sha256-/JqT3SQfawRcv/BIHPThkBvs0OEvtFFmqPF/lYI/Cxo=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.5.0/libs/lz-string.min.js"></script>
    <script>
        function encode(data, filename) {
            let code = LZString.compressToBase64(data)
            code = code.split('').map(c => c.charCodeAt(0))
            let codefill = 0
            while (codefill < code.length) codefill += 3
            let width = Math.ceil(Math.sqrt(codefill / 3))
            let pad = width * width - codefill / 3
            let w = 10
            let widthMut = width * w
            let str = `<div style="display:flex;flex-wrap:wrap; width:${widthMut}px; filter:grayscale(1); position:relative; font-size:1.5em; font-family: impact; color: white;">`
            for (let i = 0; i < codefill; i += 3) {
                str += `<div class='webcode' style="width:${w}px;height:${w}px;background:rgb(${code.shift() || 0},${code.shift() || 0},${code.shift() || 0})"></div>`
            }
            for (let i = 0; i < pad; i++) {
                let empty = Math.round(Math.random() * 60 + 20);
                str += `<div style="width:${w}px;height:${w}px;background:rgba(${empty},${empty},${empty},.9)"></div>`
            }
            str += `<div style="position:absolute;left:0px;top:0px;width:100%;height:100%;display:flex;justify-content:center;align-items:center;">${filename}</div>`
            str += '</div>'
            return str;
        }

        function decode(webcode) {
            let wrapper = document.createElement('div')
            wrapper.innerHTML = webcode;
            let d = [...wrapper.getElementsByClassName('webcode')]
                .map(c => c.style.background.split(')')[0]
                    .split('(')[1]).join(',').split(',')
                .map(c => String.fromCharCode(c)).join('')
            return '<div style="margin:80px 0px;">' + webcode + '<div></div>' + LZString.decompressFromBase64(d) + '</div>'
        }

        $(() => {
            $('#uploadTrigger').click(() => $('#upload').click())
            $('#upload').on('change', function (e) {
                const f = e.target.files[0]
                var fr = new FileReader()
                fr.onload = () => {
                    $(e.target).val('')
                    let filename = prompt('name your file') || 'Open WebCode'
                    let code = encode(fr.result, filename)
                    const link = document.createElement('a');
                    const file = new Blob([code], { type: 'text/plain' });
                    link.setAttribute('href', URL.createObjectURL(file));
                    link.setAttribute('download', 'webcode-' + filename + '.html');
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                };
                fr.readAsText(f);
            })

            $('#uploadWCTrigger').click(() => $('#uploadWC').click())
            $('#uploadWC').on('change', function (e) {
                const f = e.target.files[0]
                var fr = new FileReader()
                fr.onload = () => {
                    $(e.target).val('')
                    const d = decode(fr.result)
                    console.log(d)
                    $('#WCArea').html(d)
                };
                fr.readAsText(f);
            })
        })
    </script>
</body>

</html>